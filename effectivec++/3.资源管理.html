<html>
<head>
  <title>3.资源管理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="468"/>
<h1>3.资源管理</h1>

<div>
<span><div><span style="font-size: 14pt;">3.资源管理</span></div><div><br/></div><div><font style="font-size: 14pt;">条款13：以对象管理资源</font></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>class Investment{...};</div><div>Investment* createInvestment();</div><div><br/></div><div>void f()</div><div>{</div><div>    Investment* pInv=createInvestment();</div><div>    ...                //这里return或者抛出异常，均不会执行delete</div><div>    delete pInv;</div><div>}</div><div>//为了确保createInvestment返回的资源总是被释放，我们需要资源放进对象内，当控制流离开f，该对象的析构函数会自动释放那些资源</div><div><br/></div><div>void f()</div><div>{</div><div>    std::auto_ptr&lt;Investment&gt; pInv(createment());</div><div>    ...</div><div>}</div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">void f()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    std::tr1::shared_ptr&lt;Investment&gt; pInv(createment());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div>RAII(Resource Acqusiton Is Initialization)资源获取初始化</div><div>管理资源的最好方法其实是预防，而好的方法是尽量不去使用c/c++原生指针，一个“忘记”，就是一个隐患</div><div>（1）为了防止资源泄漏，使用RAII思想，他们在构造函数中获得字眼，并在析构函数中释放资源</div><div>（2）两个常用的RAII类是shared_ptr,auto_ptr,但前者一般是更佳选择，因为copy行为更直观。若使用auto_ptr,复制动作会使他指向null</div><div><br/></div><div><font style="font-size: 14pt;">条款14：在资源类中小心copying行为</font></div><div><br/></div><div>在条款13讲述的RAII的资源管理方法中，是开辟在堆上，但并不是所有的资源都开辟在堆上，有时候要建立自己的资源管理类。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>void lock(Mutex* mu);//加锁  </div><div>void unlock(Mutex* mu);//解锁  </div><div><br/></div><div>// <span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">为了确保给上锁的Mutex变量解锁，我们需要建立一个类来管理Mutex锁。这个类按照RAII方法来建立</span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">class clock</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">{</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">public:</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">    explicit Lock(Mutex* mu):mutexPtr(mu)</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">    {</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">        lock(mutexPter);</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">    }</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">    ~Lock()</font></span></div><div><font style="font-size: 9pt;">    {</font></div><div><font style="font-size: 9pt;">        unlock(mutexPtr);</font></div><div><font style="font-size: 9pt;">    }</font></div><div><font style="font-size: 9pt;">private:</font></div><div><font style="font-size: 9pt;">    Mutex* muterPtr;</font></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">}</font></span></div><div><br/></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">//但是如果Lock对象被复制会发生什么？</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">Lock ml1(&amp;m);</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">Lock ml2(ml1);</font></span></div></div><div><br/></div><div>1.禁止复制。将copying操作声明为private。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>class Lock:private Uncopyable</div><div>{</div><div>    public:</div><div>        ...</div><div>}</div></div><div>2.对管理资源类使用引用计数法</div><div><span style="color: rgb(51, 51, 51); font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">有时候我们希望保持资源直到最后一个使用者。这时RAII对象复制时，应该将持有资源的引用计数器加一。例如shared_ptr。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>class Lock:private Uncopyable</div><div>{</div><div>public:</div><div><span>    explicit Lock(Mutex* mu):mutexPtr(mu,unlock)</span><br/></div><div><span><span>    {</span><br/></span></div><div><span><span>    </span><span>    lock(mutexPtr);</span><br/></span></div><div><span><span>    }</span><br/></span></div><div><span>private:</span></div><div><span><span>    shared_ptr&lt;Mutex&gt; mutexPtr;</span><br/></span></div><div>}</div></div><div>3.复制底部资源</div><div>将原来的浅拷贝换成深拷贝，需要自己显示定义拷贝构造函数和赋值运算符</div><div><br/></div><div>4.转移底部资源的拥有权</div><div>在某些场合下永远保持一个RAII对象指向一个为加工资源，复制时资源的拥有权从被复制物转移到目标物。</div><div><br/></div><div>（1）复制RAII对象必须一并复制它所管理的资源，所以资源的copying行为决定RAII对象的copying行为</div><div>（2）普遍而常见的RAII class copying 行为是：抑制copying，施行引用计数法。不过其他行为也都可以实现。</div><div><br/></div><div><br/></div><div><font style="font-size: 14pt;">条款15：在资源管理类中提供对原始资源的访问</font></div><div><br/></div><div>许多APIs要求使用原始资源，</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>shared_ptr&lt;Investment&gt; pInv=(createInverstment());</div><div>//如果一个API是这样的</div><div>int dayHeld(const Investment* pi);</div><div>/// <span style="color: rgb(51, 51, 51); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font face="微软雅黑" style="font-size: 9pt;">显然是无法使用shared_ptr对象的。这时候资源管理类需要一个函数，将管理的原始资源暴露出来（即返回原始资源的直接访问方法）</font></span></div><div><span style="color: rgb(51, 51, 51); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font face="微软雅黑" style="font-size: 9pt;">dayHeld(pInv,get());</font></span></div></div><div><font style="font-size: 9pt;"><br/></font></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 10pt;">为了使智能指针使用起来像普通指针一样，它们要重载指针取值（pointer dereferencing）操作符（operator-&gt;和operator*)，它们允许转换至底部原始指针</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">class Investment</span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">{</span></div><div><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span>    public:</span><br/></span></div><div><span><span>    </span><span>    bool isTaxFree() const;</span><br/></span></div><div>}</div><div><br/></div><div>shared_ptr&lt;Investment&gt; pi(createInvestment());</div><div>pi-&gt;isTaxFree();//通过operator-&gt;访问</div><div>(*pi).isTaxFree():</div></div><div><br/></div><div>如果我们必须要使用RAII class的原始资源，通常有两种做法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div> FontHandle getFont();//C的API。为求简化省略参数  </div><div> void releaseFont(FontHandle fh);  </div><div>   </div><div> class Font</div><div>{//RAII class  </div><div> public:  </div><div>     explicit Font(FontHandle fh):f(fh)  </div><div>     {}  </div><div>     ~Font(){releaseFont(f);}  </div><div> private:  </div><div>     FontHandle f;  </div><div> };</div><div><br/></div><div>//如果有大量的API，他们要出入的是FontHandle，那么将Font转换为FontHandle是比较频繁的事</div><div>//可以提供一个显示转换函数，或者隐式转换</div><div>class Font</div><div>{</div><div>public:</div><div><span>    FontHandle get() const{return f;};//显示转换</span></div><div><span>    operator FontHandle() const{return f;}//隐示转换</span><br/>
}</div></div><div><br/></div><div>（1）一些应用程序接口往往要求访问到原始资源，所以每一个RAII类都应该提供一个“取得所管理资源的方法”；</div><div>（2）对原始资源的访问可能经由显示或隐式转换，一般而言显示转换比较安全（用get而不用operator T*（））</div></span>
</div></body></html> 