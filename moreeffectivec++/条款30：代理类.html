<html>
<head>
  <title>条款30：代理类</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1618"/>
<h1>条款30：代理类</h1>

<div>
<span><div>条款30：代理类</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int data[10][20];                          //合法</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">void processInput(int dim1, int dim2)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  int data[dim1][dim2];                 //不合法            </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...                                       </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}    </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int *data =</span><span style="font-family: Monaco; font-size: 9pt;">new int[dim1][dim2];            //不合法          </span></div></div><div><br/></div><div>（1）实现二维数组</div><div>可以定义一个类模板来实现二维数组</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">template&lt;class T&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Array2D {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  Array2D(int dim1, int dim2);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">};</span></div></div><div>上述三种表达方式都正确，然后与c、c++习惯不同，又没有operator[][]。</div><div>可以通过重载operator（）<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">template&lt;class T&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Array2D {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  // declarations that will compile</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  T&amp; operator()(int index1, int index2);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const T&amp; operator()(int index1, int index2) const;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">};</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">cout&lt;&lt;data(3)(6);</span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int data[10][20];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">cout &lt;&lt; data[3][6];          // fine</span></div></div><div>变量 data 不是真正的二维数组，它是一个 10 元素的一维数组。其中每一个元素又都是一个20 元素的数组，所以表达式 data[3][6]实际上是(data[3])[6]</div><div><br/></div><div>同样可以重载 Array2D 类的 operator[]来玩同样的把戏。Array2D 的 operator[]返回一个新类 Array1D 的对象。再重载 Array1D 的 operator[]来返回所需要的二维数组中的元素</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">template&lt;class T&gt;<span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Array2D {</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  class Array1D {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    T&amp; operator[](int index);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const T&amp; operator[](int index) const;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  Array1D operator[](int index);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const Array1D operator[](int index) const;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">};</span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Array2D&lt;float&gt; data(10, 20);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">cout &lt;&lt; data[3][6];          // fine</span></div></div><div>Array1D是一个代理类。它的实例扮演的是一个在概念上不存在的一维数组。被称为代理类。</div><div><br/></div><div>（2） 区分通过 operator[]进行的是读操作还是写操作</div><div>也许不可能在 operator[]内部区分左值还是右值操作，但我们仍然能区别对待读操作和写操作，如果我们将判断读还是写的行为推迟到我们知道operator[]的结果被怎么使用之后的话。我们所需要的是有一个方法将读或写的判断推迟到operator[]返回之后。（这是 lazy原则）</div><div><br/></div><div>proxy类上只能做三件事</div><div>1. 创建它，也就是指定它扮演哪个字符。</div><div>2.将它作为赋值操作的目标，在这种情况下可以将赋值真正作用在它扮演的字符上。这样被使用时，proxy类扮演的是左值。</div><div>3. 用其它方式使用它。这时，代理类扮演的是右值。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>//<span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">一个被带引用计数的string类用作proxy类以区分operator[]是作左值还是右</span><span style="font-family: Monaco; font-size: 9pt;">值使用的例子</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class String {                   </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public:                         </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  class CharProxy {              </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    CharProxy(String&amp; str, int index);            <span>    </span><span>    </span><span>    </span>    // creation</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    CharProxy&amp; operator=(const CharProxy&amp; rhs);       // lvalue <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">uses</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    CharProxy&amp; operator=(char c);                 </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    operator char() const;                         <span>    </span><span>    </span><span>    </span><span>    </span>   // rvalue <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                       </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  private:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    String&amp; theString;            // string this proxy pertains to</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    int charIndex;                // char within that string</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                  // this proxy stands for</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  // continuation of String class</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const CharProxy</span><span style="font-family: Monaco; font-size: 9pt;"> operator[](int index) const;   // for const Strings</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  CharProxy operator[](int index); // for non-const Strings</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">friend class CharProxy;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">private:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  RCPtr&lt;StringValue&gt; value;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">};</span></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">cout &lt;&lt; s1[5];</span></div></div><div>s1[5]返回的是一CharProxy对象。没有为这样的对象定义输出流操作，所以编译器努力地寻找一个隐式的类型转换以使得 operator&lt;&lt;调用成功，在 CahrProxy 类内部申明了一个隐式转换到 char 的操作。于是自动调用这个转换操作，结果就是 CharProxy 类扮演的字符被打印输出了。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">s2[5] = 'x';</span></div></div><div>s2[5]返回的是一个CharProxy对象，这至关重要，因为在 CharProxy的赋值操作中，我们知道被赋值的CharProxy对象是作左值使用的。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const String::CharProxy String::operator[](int index) const</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return CharProxy(const_cast&lt;String&amp;&gt;(*this), index);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String::CharProxy String::operator[](int index)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return CharProxy(*this, index);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String::CharProxy::CharProxy(String&amp; str, int index)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">: theString(str), charIndex(index) {}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String::CharProxy::operator char() const</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return theString.value-&gt;data[charIndex];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String::CharProxy&amp; </span>String::CharProxy::operator=(const CharProxy&amp; rhs)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  if (theString.value-&gt;isShared()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    theString.value = new StringValue(theString.value-&gt;data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  theString.value-&gt;data[charIndex] =</span><span style="font-family: Monaco; font-size: 9pt;"> rhs.theString.value-&gt;data[rhs.charIndex];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return *this;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String::CharProxy&amp; String::CharProxy::operator=(char c)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  if (theString.value-&gt;isShared()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    theString.value = new StringValue(theString.value-&gt;data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  theString.value-&gt;data[charIndex] = c;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return *this;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>（3）局限性</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">String s1 = &quot;Hello&quot;;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">char *p = &amp;s1[1];            // error</span></div></div><div>没有从CharProxy *到 char *的转换函数</div><div>重载取地址运算符</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class String {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  class CharProxy {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  public:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    char * operator&amp;();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const char * operator&amp;() const;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">};</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const char * String::CharProxy::operator&amp;() const</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return &amp;(theString.value-&gt;data[charIndex]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">char * String::CharProxy::operator&amp;()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  if (theString.value-&gt;isShared()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    theString.value = new StringValue(theString.value-&gt;data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  theString.value-&gt;markUnshareable();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return &amp;(theString.value-&gt;data[charIndex]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div></span>
</div></body></html> 