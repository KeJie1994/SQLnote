<html>
<head>
  <title>条款34：如何在同一程序中混合使用 C++和 C</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1632"/>
<h1>条款34：如何在同一程序中混合使用 C++和 C</h1>

<div>
<span><div><span style="font-size: 14pt;">条款34：如何在同一程序中混合使用 C++和 C</span></div><div><br/></div><div>在实体混合编程前，确保你的 C++编译器和 C 编译器兼容。确认兼容后，还有四个要考虑的问题：名变换，静态初始化，内存动态分配，数据结构兼容。</div><div><br/></div><div>（1）名变换</div><div>就是C++编译器给程序的每个函数换一个独一无二的名字。在C 中，这个过程。是不需要的，因为没有函数重载。<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//如果你调用一个名字为 drawLine 的 C</span><span style="font-family: Monaco; font-size: 9pt;">函数，它实际上就叫 drawLine</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">extern &quot;C&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">void drawLine(int x1, int y1, int x2, int y2);</span></div></div><div><br/></div><div>如果有一组函数</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">extern &quot;C&quot; {                     </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void drawLine(int x1, int y1, int x2, int y2);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void twiddleBits(unsigned char bits);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void simulate(int iterations);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div>但用 C 编译时，不应该这样。通过只在 C++编译器下定义的宏__cplusplus，你可以将头文件组织得这样：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#ifdef __cplusplus</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">extern &quot;C&quot; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#endif</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void drawLine(int x1, int y1, int x2, int y2);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void twiddleBits(unsigned char bits);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  void simulate(int iterations);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#ifdef __cplusplus</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#endif</span></div></div><div>（2）静态初始化</div><div>在 main 执行前和执行后都有大量代码被执行。静态的类对象和定义在全局的、命名空间中的或文件体中的类对象的构造函数通常在 main 被执行前就被调用。这和我们对 C++和 C 程序的通常认识相反，我们将main()今天作为程序入口，结束作为程序完成。</div><div>许多编译器在main()的最开始处插入了一个特别的函数，由它来负责静态初始化。同样地，编译器在main()结束处插入了一个函数来析构静态对象。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int main(int argc, char *argv[])</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  performStaticInitialization();     </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  the statements you put in main go here;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  performStaticDestruction();         </span></div><div><span style="font-family: Monaco; font-size: 9pt;">}</span><br/></div></div><div>要点是：如果一个 C++编译器采用这种方法来初始化和析构静态对象，只要程序的任意部分是C++写的，你就应该用 C++写main()函数。</div><div><br/></div><div>比如程序的大部分是C的，C++部分只是一个支持库，只要将C写的main()改名为 realMain()，然后用C++版本的 main()调用realMain()：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">extern &quot;C&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int realMain(int argc, char *argv[]);     // function in C</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">int main(int argc, char *argv[])          // write this in C++</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  return realMain(argc, argv);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div>（3）动态内存分配</div><div>C++部分使用new和delete，C 部分使用 malloc和 free</div><div>（4）数据结构的兼容性</div><div>在 C++和C之间这样相互传递数据结构是安全的－－在C++和 C下提供同样的定义来进行编译。在C++版本中增加非虚成员函数或许不影响兼容性，但几乎其它的改变都将影响兼容。</div><div><br/></div><div>总结：</div><div>如果想在同一程序下混合C++与C 编程，记住下面的指导原则：</div><div>1. 确保C++和C 编译器产生兼容的obj文件。</div><div>2.将在两种语言下都使用的函数申明为 extern 'C'。</div><div>3. 只要可能，用C++写main()。</div><div>4.总用delete释放 new 分配的内存；总用 free释放malloc分配的内存。</div><div>5.将在两种语言间传递的东西限制在用 C编译的数据结构的范围内；这些结构的 C++</div><div>版本可以包含非虚成员函数。</div><div><br/></div></span>
</div></body></html> 